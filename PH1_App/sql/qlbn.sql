create or replace procedure sp_dropif (t_name IN NVARCHAR2)
as
begin
  EXECUTE IMMEDIATE 'DROP TABLE ' || t_name || ' CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN
         RAISE;
      END IF;
end;
/
exec sp_dropif('HSBA');
exec sp_dropif('HSBA_DV');
exec sp_dropif('BENHNHAN');
exec sp_dropif('CSYT');
exec sp_dropif('NHANVIEN');
/

CREATE TABLE HSBA(
    MAHSBA      NUMBER NOT NULL,
    MABN        NUMBER,
    NGAY        DATE,
    CHANDOAN    NVARCHAR2(100),
    MABS        NUMBER,
    MAKHOA      NUMBER,
    MACSYT      NUMBER,
    KETLUAN     NVARCHAR2(100),
    
    PRIMARY KEY(MAHSBA)
);

CREATE TABLE HSBA_DV(
    MAHSBA      NUMBER NOT NULL,
    MADV        Number Not Null,
    NGAY        DATE NOT NULL,
    MAKTV       NUMBER,
    KETQUA      NVARCHAR2(100)
);

CREATE TABLE BENHNHAN(
    MABN        NUMBER NOT NULL,
    MACSYT      NUMBER,
    TENBN       NVARCHAR2(25),
    CMND        NVARCHAR2(10),
    NGAYSINH    DATE,
    SONHA       NUMBER,
    TENDUONG    NVARCHAR2(25),
    QUANHUYEN   NVARCHAR2(25),
    TINHTP      NVARCHAR2(20),
    TIENSUBENH  NVARCHAR2(100),
    TIENSUBENHGD NVARCHAR2(200),
    DIUNGTHUOC  NVARCHAR2(200),
    
    PRIMARY KEY(MABN)
);

CREATE TABLE CSYT(
    MACSYT      NUMBER NOT NULL,
    TENCSYT     NVARCHAR2(25),
    DCCSYT      NVARCHAR2(50),
    SDTCSYT     NVARCHAR2(10),
    
    PRIMARY KEY (MACSYT)
);

CREATE TABLE NHANVIEN(
    MANV        NUMBER NOT NULL,
    HOTEN       NVARCHAR2(25),
    PHAI        NVARCHAR2(5),
    NGAYSINH    DATE,
    CMND        NVARCHAR2(10),
    QUEQUAN     NVARCHAR2(20),
    SODT        NVARCHAR2(10),
    CSYT        NUMBER,
    VAITRO      NVARCHAR2(15),
    CHUYENKHOA  NVARCHAR2(15),
    
    PRIMARY KEY(MANV)
);

CREATE TABLE THONGBAO(
    NOIDUNG     NVARCHAR2(1000),
    NGAYGIO     DATE,
    DIADIEM     NVARCHAR2(100)
);

-- Thêm khóa ngoại vào các bảng
ALTER TABLE HSBA
ADD CONSTRAINT FK_MABS_MANV FOREIGN KEY (MABS) REFERENCES NHANVIEN(MANV);

ALTER TABLE HSBA
ADD CONSTRAINT FK_MABN_MABN FOREIGN KEY (MABN) REFERENCES BENHNHAN(MABN);

ALTER TABLE HSBA_DV
ADD CONSTRAINT FK_HSBA_HSBA FOREIGN KEY (MAHSBA) REFERENCES HSBA(MAHSBA);

ALTER TABLE HSBA_DV
ADD CONSTRAINT PK_MAHS_MADV_NGAY PRIMARY KEY(MAHSBA, MADV, NGAY);

ALTER TABLE HSBA_DV
ADD CONSTRAINT FK_MAKTV_MANV FOREIGN KEY (MAKTV) REFERENCES NHANVIEN(MANV);

ALTER TABLE BENHNHAN
ADD CONSTRAINT FK_MACSYT_MACSYT FOREIGN KEY (MACSYT) REFERENCES CSYT(MACSYT);

ALTER TABLE NHANVIEN
ADD CONSTRAINT FK_CSYT_MACSYT FOREIGN KEY (CSYT) REFERENCES CSYT(MACSYT);

ALTER TABLE NHANVIEN
ADD CONSTRAINT CHECK_VAITRO CHECK (VAITRO IN (N'Y sĩ/bác sĩ', N'Nghiên cứu',N'Thanh tra', N'Cơ sở y tế'));

-- Tạo role và phân quyền người dùng
ALTER SESSION SET "_ORACLE_SCRIPT"=true;

CREATE ROLE BENHNHAN;
CREATE ROLE THANHTRA;
CREATE ROLE COSOYTE;
CREATE ROLE YBACSI;
CREATE ROLE NGHIENCUU;
CREATE ROLE NHANVIEN;

CREATE USER "900001" IDENTIFIED BY "lbcphat123";
CREATE USER "900002" IDENTIFIED BY "nhkhoi123";
CREATE USER "900003" IDENTIFIED BY "nsbao123";
CREATE USER "900004" IDENTIFIED BY "pstung123";

GRANT DBA TO "900001";
GRANT DBA TO "900002";
GRANT DBA TO "900003";
GRANT DBA TO "900004";

--Phân quyền cho từng vai trò


GRANT SELECT ON HSBA TO THANHTRA;
GRANT SELECT ON HSBA_DV TO THANHTRA;
GRANT SELECT ON BENHNHAN TO THANHTRA;
GRANT SELECT ON CSYT TO THANHTRA;
GRANT SELECT ON NHANVIEN TO THANHTRA;


GRANT INSERT, DELETE ON HSBA TO COSOYTE;
GRANT INSERT, DELETE ON HSBA_DV TO COSOYTE;

GRANT SELECT ON HSBA TO YBACSI;
GRANT SELECT ON HSBA_DV TO YBACSI;
GRANT SELECT, INSERT(MABN, CMND) ON BENHNHAN TO YBACSI;

GRANT SELECT ON HSBA TO NGHIENCUU;
GRANT SELECT ON HSBA_DV TO NGHIENCUU;

GRANT SELECT, UPDATE (HOTEN, PHAI, NGAYSINH, CMND, QUEQUAN, SODT,CSYT, VAITRO, CHUYENKHOA) ON NHANVIEN TO NHANVIEN;

GRANT SELECT, UPDATE(TENBN, CMND, NGAYSINH, SONHA, TENDUONG, QUANHUYEN, TINHTP, TIENSUBENH, TIENSUBENHGD, DIUNGTHUOC) ON BENHNHAN TO BENHNHAN;


Alter Session Set "_ORACLE_SCRIPT"=false;

-- SELECT SYS_CONTEXT('USERENV', 'SERVER_HOST') FROM DUAL;
